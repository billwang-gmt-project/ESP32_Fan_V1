# UART1 RPM 測量方案評估報告

## 現況分析

### 當前實現 (PCNT - Pulse Counter)

**配置：**
- 外設：PCNT_UNIT_0
- GPIO：18 (UART1 RX)
- 測量方式：在 100ms 時間窗口內計數脈衝
- 計算公式：`frequency = count × 10`
- 濾波器：13µs (過濾 < 77kHz 的毛刺)

**優點：**
✅ CPU 負擔極低（硬體計數）
✅ 實現簡單，程式碼少
✅ 不需要 ISR 處理
✅ PCNT 資源豐富（ESP32-S3 有 8 個 units）
✅ 適合高頻測量（5-20kHz 範圍）
✅ 記憶體開銷小

**缺點：**
⚠️ 時間分辨率固定為 100ms
⚠️ 低頻時精度差（例如 10 Hz → 每 100ms 只有 1 個脈衝）
⚠️ 無法偵測瞬時頻率變化
⚠️ 最低可測頻率：10 Hz（受 100ms 窗口限制）

### 替代方案 (MCPWM Capture - Timer Capture)

**配置建議：**
- 外設：MCPWM_UNIT_0, CAP1 (CAP0 已被 Motor Tach 使用)
- GPIO：18 (UART1 RX)
- 測量方式：捕獲每個脈衝的時間戳，計算週期
- 計算公式：`frequency = 80,000,000 / (capture_period)`
- 時鐘：80 MHz APB clock

**優點：**
✅ **高精度**：低頻時精度大幅提升（1 Hz 也可精確測量）
✅ **即時響應**：每個脈衝都觸發測量，無需等待時間窗口
✅ **寬頻率範圍**：1 Hz - 數百 kHz（實測主馬達可測到 500 kHz）
✅ **週期測量**：可以檢測頻率變化（例如加減速過程）
✅ **與主馬達一致**：使用相同的測量技術

**缺點：**
❌ 需要 ISR 處理（增加 CPU 負擔，但很小）
❌ 程式碼較複雜（需處理 ISR、counter overflow）
❌ 需額外佔用 MCPWM Capture 通道（但資源充足）
❌ 高頻時 ISR 頻率高（20 kHz → 每秒 20,000 次中斷）

---

## 資源佔用分析

### 當前硬體資源使用

| 外設 | Unit/Channel | GPIO | 用途 |
|------|-------------|------|------|
| MCPWM_UNIT_1 | Timer 0, OP A | 10 | Motor PWM 輸出 |
| MCPWM_UNIT_0 | CAP0 | 11 | Motor Tachometer (已使用 Capture) |
| PCNT_UNIT_0 | - | 18 | UART1 RPM (當前) |
| LEDC | Timer 2, CH 2 | 17 | UART1 PWM 輸出 |

### 可用資源

**MCPWM Capture 通道：**
- MCPWM_UNIT_0: ✅ CAP1, CAP2 可用
- MCPWM_UNIT_1: ✅ CAP0, CAP1, CAP2 全部可用

**PCNT Units:**
- ✅ UNIT_1 到 UNIT_7 全部可用

**結論：硬體資源充足，兩種方案都可行**

---

## 性能對比

### 測試場景對比

| 測試頻率 | PCNT 精度 | MCPWM Capture 精度 | 優勝方案 |
|---------|----------|-------------------|---------|
| **10 Hz** | ±10% (1 ± 0.1 個脈衝/100ms) | ±0.001% (週期測量) | **MCPWM** |
| **100 Hz** | ±1% (10 ± 1 個脈衝/100ms) | ±0.001% | **MCPWM** |
| **1000 Hz** | ±0.1% (100 ± 1 個脈衝/100ms) | ±0.001% | 相當 |
| **5000 Hz** | ±0.02% (500 個脈衝/100ms) | ±0.001% | 相當 |
| **20 kHz** | ±0.005% (2000 個脈衝/100ms) | ±0.001% | 相當 |

### CPU 負擔估算

**PCNT (當前):**
- ISR：0 次/秒
- 更新函數：每 100ms 呼叫一次（10 次/秒）
- CPU 時間：< 0.1%

**MCPWM Capture:**
- ISR：等於測量頻率（10 Hz → 10 次/秒，20 kHz → 20,000 次/秒）
- ISR 執行時間：~2-5 µs/次（參考主馬達實測）
- CPU 時間估算：
  - 100 Hz: 100 × 5µs = 0.5ms/s = **0.05%**
  - 1000 Hz: 1000 × 5µs = 5ms/s = **0.5%**
  - 5000 Hz: 5000 × 5µs = 25ms/s = **2.5%**
  - 20 kHz: 20000 × 5µs = 100ms/s = **10%**

---

## 測試結果分析（您的實測數據）

### 問題場景回顧

您的測試顯示：
- ✅ 100 Hz: 誤差 0.00%
- ✅ 1000 Hz: 誤差 0.00%
- ✅ 5000 Hz: 誤差 0.00%
- ⚠️ **10000 Hz: 誤差 50.00%**（實際原因是 LEDC PWM 輸出限制，非 PCNT 測量問題）

**重要發現：**
1. PCNT 在 100-5000 Hz 範圍表現完美
2. 10000 Hz 問題是 **PWM 輸出端** (LEDC) 的限制，不是測量端的問題
3. PCNT 已證實可以準確測量到至少 5000 Hz

### 是否需要改為 MCPWM Capture？

**關鍵問題：您的應用需求是什麼？**

---

## 建議決策矩陣

### 👍 **建議保留 PCNT，如果：**

1. ✅ **頻率範圍主要在 100 Hz - 5 kHz**（您的測試範圍）
2. ✅ **不需要測量 < 10 Hz 的低頻信號**
3. ✅ **100ms 更新率足夠**（大部分應用都夠）
4. ✅ **希望保持簡單、低 CPU 負擔**
5. ✅ **UART1 主要用於中高頻 PWM/RPM 測量**

**理由：**
- 當前實現已證實在目標範圍內完美工作
- 簡單可靠，無需維護複雜的 ISR
- 節省 MCPWM 資源給未來擴展

---

### 👍 **建議改為 MCPWM Capture，如果：**

1. ✅ **需要測量 < 10 Hz 的低速信號**
2. ✅ **需要即時響應（< 100ms）**
3. ✅ **需要偵測瞬時頻率變化**（加減速過程）
4. ✅ **希望與主馬達使用一致的測量技術**
5. ✅ **追求最高精度**（所有頻率範圍）

**理由：**
- 主馬達已使用 MCPWM Capture 且運作良好
- 程式碼模式可重用（減少開發時間）
- 未來功能擴展性更好

---

## 實作評估

### 如果選擇改為 MCPWM Capture

**工作量評估：**

1. **修改 UART1Mux.h** (~30 行)
   - 添加 MCPWM Capture 相關定義
   - 添加 ISR callback 函數聲明
   - 添加 capture period 變數

2. **修改 UART1Mux.cpp** (~100 行)
   - `initRPM()`: 改用 `mcpwm_capture_enable_channel()`
   - `deinitRPM()`: 改用 `mcpwm_capture_disable_channel()`
   - 添加 `captureCallback()`: ISR 處理 (參考 MotorControl.cpp:140-163)
   - `updateRPMFrequency()`: 從 capture period 計算頻率

3. **修改 PeripheralPins.h** (~5 行)
   - 定義 MCPWM Capture 通道（建議 MCPWM_UNIT_0, CAP1）
   - 移除或保留 PCNT_UNIT_UART1_RPM（供未來參考）

4. **測試驗證** (~1-2 小時)
   - 驗證所有頻率點（1 Hz - 20 kHz）
   - 確認無干擾主馬達 Capture
   - 性能測試（CPU 使用率）

**預估時間：2-3 小時**（含測試）

**風險評估：**
- 🔸 低風險：技術已驗證（主馬達在用）
- 🔸 需注意：GPIO 18 的 MCPWM routing（可能需要 GPIO matrix 配置）
- 🔸 需注意：確保 MCPWM_UNIT_0 的 CAP1 無衝突

---

## 最終建議

### 📊 綜合評分

| 方案 | 精度 | 性能 | 複雜度 | 擴展性 | 總分 |
|-----|------|------|--------|--------|------|
| **PCNT (當前)** | 8/10 | 10/10 | 10/10 | 7/10 | **35/40** |
| **MCPWM Capture** | 10/10 | 8/10 | 6/10 | 10/10 | **34/40** |

### 🎯 我的建議

**如果您的需求是：**
- 主要測量 100 Hz - 10 kHz 範圍的 PWM 信號
- 100ms 更新率可接受
- 希望保持系統簡潔

**➡️ 建議：保留 PCNT 方案**

**理由：**
1. ✅ 您的測試已證實 PCNT 在目標範圍內表現完美
2. ✅ 更簡單、更穩定、CPU 負擔更低
3. ✅ 節省 MCPWM 資源給未來功能（例如增加更多 Capture 通道）
4. ✅ "如果沒壞，就不要修" (If it ain't broke, don't fix it)

---

**但如果您需要：**
- 測量很低的頻率（< 10 Hz）
- 即時頻率監測（< 100ms 響應）
- 與主馬達完全一致的測量技術

**➡️ 建議：改用 MCPWM Capture**

**理由：**
1. ✅ 精度大幅提升（特別是低頻）
2. ✅ 程式碼可參考 MotorControl（已驗證）
3. ✅ 資源充足，無衝突風險
4. ✅ 工作量可控（2-3 小時）

---

## 決策輔助問題

請回答以下問題，幫助您做決定：

1. **UART1 RPM 功能主要用於測量什麼頻率範圍？**
   - [ ] < 10 Hz（例如：慢速電機）
   - [ ] 10-100 Hz（例如：風扇）
   - [x] 100-5000 Hz（您已測試的範圍）
   - [ ] > 5 kHz（高速信號）

2. **是否需要即時響應（< 100ms）？**
   - [ ] 是，需要即時監控頻率變化
   - [ ] 否，100ms 更新率足夠

3. **是否需要偵測加減速過程的瞬時頻率？**
   - [ ] 是
   - [ ] 否

4. **當前 PCNT 方案是否已滿足需求？**
   - [ ] 是，沒有問題
   - [ ] 否，有以下問題：_____________

---

## 總結

**現況：** PCNT 方案運作良好，測試通過 ✅

**建議：**
- **短期**：保留 PCNT（除非有明確需求）
- **長期**：如需低頻/高精度，再考慮升級到 MCPWM Capture

**您可以：**
1. 先保留 PCNT，專注解決 LEDC PWM 輸出限制（已在 v2.5.1 修正）
2. 等實際應用發現 PCNT 不足時，再升級
3. 或立即升級到 MCPWM Capture，追求最佳精度和一致性

**請告訴我您的決定！** 🚀
