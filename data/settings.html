<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±è¨­ç½® - BillCat Fan Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .page-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            background: transparent;
        }

        .language-bar {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            text-align: right;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
        }

        .language-bar label {
            font-weight: bold;
            margin-right: 10px;
            color: #2c3e50;
            font-size: 14px;
        }

        .language-bar select {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 14px;
            min-width: 130px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .navigation-bar {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            text-align: center;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-link {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-link:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .nav-link.active {
            background: #764ba2;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .title {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 1.2em;
            color: #7f8c8d;
            font-weight: 300;
        }

        .settings-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .section-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .form-group .help-text {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .status-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .status-info .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .status-info .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }

        .status-info .info-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .status-info .info-value {
            color: #7f8c8d;
        }

        /* Emergency Stop Error Banner */
        .error-banner {
            background: rgba(231, 76, 60, 0.15);
            border: 2px solid #e74c3c;
            border-radius: 12px;
            padding: 15px 20px;
            margin: 20px;
            display: none;
            animation: pulse 2s ease-in-out infinite;
        }

        .error-banner.show {
            display: block;
        }

        .error-banner-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .error-banner-text {
            color: #e74c3c;
            font-weight: bold;
            font-size: 16px;
            flex: 1;
            min-width: 200px;
        }

        .error-banner-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .btn-warning {
            background: #f39c12;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- å°èˆªåˆ— -->
        <div class="navigation-bar">
            <div class="nav-links">
                <a href="/index.html" class="nav-link">
                    <span class="lang-zh-CN">ä¸»æ§åˆ¶å°</span>
                    <span class="lang-en">Dashboard</span>
                </a>
                <a href="/peripherals.html" class="nav-link">
                    <span class="lang-zh-CN">âš™ï¸ å¤–è®¾æ§åˆ¶</span>
                    <span class="lang-en">âš™ï¸ Peripherals</span>
                </a>
                <a href="/console.html" class="nav-link">
                    <span class="lang-zh-CN">ğŸ–¥ï¸ æ§åˆ¶å°</span>
                    <span class="lang-en">ğŸ–¥ï¸ Console</span>
                </a>
            </div>
        </div>

        <!-- Emergency Stop Error Banner -->
        <div class="error-banner" id="errorBanner">
            <div class="error-banner-content">
                <div>
                    <span class="error-banner-icon">â›”</span>
                    <span class="error-banner-text" id="errorBannerText">SAFETY ALERT: Emergency stop activated!</span>
                </div>
                <button class="btn-warning" onclick="clearError()">
                    <span class="lang-zh-CN">æ¸…é™¤éŒ¯èª¤ / æ¢å¾©</span>
                    <span class="lang-en">Clear Error / Resume</span>
                </button>
            </div>
        </div>

        <!-- ä¸»å®¹å™¨ -->
        <div class="container">
            <div class="header">
                <h1 class="title">
                    <span class="lang-zh-CN">ç³»çµ±è¨­ç½®</span>
                    <span class="lang-en">System Settings</span>
                </h1>
                <p class="subtitle">
                    <span class="lang-zh-CN">é…ç½®å’Œç®¡ç†æ‰€æœ‰ç³»çµ±åƒæ•¸</span>
                    <span class="lang-en">Configure and manage all system parameters</span>
                </p>
            </div>

            <!-- ç‹€æ…‹è¨Šæ¯ -->
            <div id="statusMessage" class="status-message"></div>

            <!-- ç³»çµ±ç‹€æ…‹è³‡è¨Š -->
            <div class="status-info">
                <h3>
                    <span class="lang-zh-CN">ç³»çµ±ç‹€æ…‹</span>
                    <span class="lang-en">System Status</span>
                </h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">
                            <span class="lang-zh-CN">å›ºä»¶ç‰ˆæœ¬</span>
                            <span class="lang-en">Firmware Version</span>
                        </span>
                        <span class="info-value" id="firmwareVersion">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">WiFi IP</span>
                        <span class="info-value" id="wifiIP">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">
                            <span class="lang-zh-CN">ç³»çµ±é‹è¡Œæ™‚é–“</span>
                            <span class="lang-en">Uptime</span>
                        </span>
                        <span class="info-value" id="uptime">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">
                            <span class="lang-zh-CN">å¯ç”¨è¨˜æ†¶é«”</span>
                            <span class="lang-en">Free Heap</span>
                        </span>
                        <span class="info-value" id="freeHeap">-</span>
                    </div>
                </div>
            </div>

            <!-- UI è¨­ç½® -->
            <div class="settings-section">
                <h2 class="section-title">
                    <span class="lang-zh-CN">ç•Œé¢è¨­ç½®</span>
                    <span class="lang-en">UI Settings</span>
                </h2>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">æ¨™é¡Œ</span>
                        <span class="lang-en">Title</span>
                    </label>
                    <input type="text" id="title" maxlength="50">
                    <span class="help-text">
                        <span class="lang-zh-CN">é¡¯ç¤ºåœ¨ä¸»é é¢çš„æ¨™é¡Œ</span>
                        <span class="lang-en">Title displayed on main page</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">å‰¯æ¨™é¡Œ</span>
                        <span class="lang-en">Subtitle</span>
                    </label>
                    <input type="text" id="subtitle" maxlength="50">
                    <span class="help-text">
                        <span class="lang-zh-CN">é¡¯ç¤ºåœ¨æ¨™é¡Œä¸‹æ–¹çš„å‰¯æ¨™é¡Œ</span>
                        <span class="lang-en">Subtitle displayed below title</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">BLE è£ç½®åç¨±</span>
                        <span class="lang-en">BLE Device Name</span>
                    </label>
                    <input type="text" id="bleDeviceName" maxlength="30">
                    <span class="help-text">
                        <span class="lang-zh-CN">è—ç‰™è£ç½®çš„åç¨±ï¼ˆéœ€é‡å•Ÿç”Ÿæ•ˆï¼‰</span>
                        <span class="lang-en">Bluetooth device name (requires restart)</span>
                    </span>
                </div>
            </div>

            <!-- PWM æ§åˆ¶è¨­ç½® -->
            <div class="settings-section">
                <h2 class="section-title">
                    <span class="lang-zh-CN">PWM æ§åˆ¶è¨­ç½®</span>
                    <span class="lang-en">PWM Control Settings</span>
                </h2>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">æœ€å¤§é »ç‡ (Hz)</span>
                        <span class="lang-en">Maximum Frequency (Hz)</span>
                    </label>
                    <input type="number" id="maxFrequency" min="1000" max="500000">
                    <span class="help-text">
                        <span class="lang-zh-CN">PWM é »ç‡çš„ä¸Šé™ï¼ˆ1,000 - 500,000 Hzï¼‰</span>
                        <span class="lang-en">Upper limit for PWM frequency (1,000 - 500,000 Hz)</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">æœ€å¤§å®‰å…¨è½‰é€Ÿ (RPM)</span>
                        <span class="lang-en">Max Safe RPM</span>
                    </label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="maxSafeRPM" min="1000" max="1000000" style="flex: 1;">
                        <input type="checkbox" id="maxSafeRPMEnabled" style="width: 20px; height: 20px; cursor: pointer;" title="Enable/Disable protection">
                    </div>
                    <span class="help-text">
                        <span class="lang-zh-CN">è¶…é€Ÿä¿è­·é–¾å€¼ï¼Œè¶…éæ­¤è½‰é€Ÿå°‡è§¸ç™¼ç·Šæ€¥åœæ­¢ï¼ˆå‹¾é¸ä»¥å•Ÿç”¨ä¿è­·ï¼‰</span>
                        <span class="lang-en">Overspeed protection threshold, emergency stop triggered if exceeded (check to enable)</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">å ç©ºæ¯”æ­¥é€² (%)</span>
                        <span class="lang-en">Duty Cycle Step (%)</span>
                    </label>
                    <input type="number" id="dutyStepSize" min="0.1" max="100" step="0.1">
                    <span class="help-text">
                        <span class="lang-zh-CN">èª¿æ•´å ç©ºæ¯”æ™‚çš„æ­¥é€²å€¼</span>
                        <span class="lang-en">Step size for duty cycle adjustment</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">é »ç‡æ­¥é€² (Hz)</span>
                        <span class="lang-en">Frequency Step (Hz)</span>
                    </label>
                    <input type="number" id="freqStepSize" min="1" max="100000">
                    <span class="help-text">
                        <span class="lang-zh-CN">èª¿æ•´é »ç‡æ™‚çš„æ­¥é€²å€¼</span>
                        <span class="lang-en">Step size for frequency adjustment</span>
                    </span>
                </div>
            </div>

            <!-- RPM æ¸¬é‡è¨­ç½® -->
            <div class="settings-section">
                <h2 class="section-title">
                    <span class="lang-zh-CN">RPM æ¸¬é‡è¨­ç½®</span>
                    <span class="lang-en">RPM Measurement Settings</span>
                </h2>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">æ¥µå°æ•¸</span>
                        <span class="lang-en">Pole Pairs</span>
                    </label>
                    <input type="number" id="polePairs" min="1" max="12">
                    <span class="help-text">
                        <span class="lang-zh-CN">é›»æ©Ÿçš„æ¥µå°æ•¸ï¼ˆ1-12ï¼‰</span>
                        <span class="lang-en">Motor pole pairs (1-12)</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">åœ–è¡¨æ›´æ–°ç‡ (æ¯«ç§’)</span>
                        <span class="lang-en">Chart Update Rate (ms)</span>
                    </label>
                    <select id="rpmUpdateRate">
                        <option value="20">50 Hz (20ms)</option>
                        <option value="33">30 Hz (33ms)</option>
                        <option value="50">20 Hz (50ms)</option>
                        <option value="100">10 Hz (100ms)</option>
                        <option value="200">5 Hz (200ms)</option>
                    </select>
                    <span class="help-text">
                        <span class="lang-zh-CN">RPM åœ–è¡¨æ•¸æ“šæ›´æ–°çš„é »ç‡</span>
                        <span class="lang-en">Frequency of RPM chart data updates</span>
                    </span>
                </div>
            </div>

            <!-- LED è¨­ç½® -->
            <div class="settings-section">
                <h2 class="section-title">
                    <span class="lang-zh-CN">LED ç‹€æ…‹æŒ‡ç¤ºå™¨</span>
                    <span class="lang-en">LED Status Indicator</span>
                </h2>
                <div class="form-group">
                    <label>
                        <span class="lang-zh-CN">LED äº®åº¦ (0-255)</span>
                        <span class="lang-en">LED Brightness (0-255)</span>
                    </label>
                    <input type="range" id="ledBrightness" min="0" max="255" step="1">
                    <span class="help-text">
                        <span class="lang-zh-CN">ç•¶å‰å€¼ï¼š</span>
                        <span class="lang-en">Current value: </span>
                        <span id="ledBrightnessValue">25</span>
                    </span>
                </div>
            </div>

            <!-- WiFi è¨­ç½® -->
            <div class="settings-section">
                <h2 class="section-title">WiFi
                    <span class="lang-zh-CN">è¨­ç½®</span>
                    <span class="lang-en">Settings</span>
                </h2>
                <div class="form-group">
                    <label>WiFi SSID</label>
                    <input type="text" id="wifiSSID" maxlength="32">
                    <span class="help-text">
                        <span class="lang-zh-CN">WiFi ç¶²è·¯åç¨±</span>
                        <span class="lang-en">WiFi network name</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>WiFi
                        <span class="lang-zh-CN">å¯†ç¢¼</span>
                        <span class="lang-en">Password</span>
                    </label>
                    <input type="password" id="wifiPassword" maxlength="64">
                    <span class="help-text">
                        <span class="lang-zh-CN">WiFi å¯†ç¢¼ï¼ˆ8-64 å€‹å­—å…ƒï¼‰</span>
                        <span class="lang-en">WiFi password (8-64 characters)</span>
                    </span>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="apModeEnabled" style="margin-right: 10px;">
                        <span class="lang-zh-CN">å•Ÿç”¨ AP ç†±é»æ¨¡å¼</span>
                        <span class="lang-en">Enable AP (Hotspot) Mode</span>
                    </label>
                    <span class="help-text">
                        <span class="lang-zh-CN">é–‹æ©Ÿæ™‚è‡ªå‹•å•Ÿå‹• WiFi ç†±é» (SSID: BillCat_Fan_Control, IP: 192.168.4.1)</span>
                        <span class="lang-en">Auto-start WiFi hotspot on boot (SSID: BillCat_Fan_Control, IP: 192.168.4.1)</span>
                    </span>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="button-group">
                <button class="btn btn-success" onclick="loadSettings()">
                    <span class="lang-zh-CN">è¼‰å…¥è¨­ç½®</span>
                    <span class="lang-en">Load Settings</span>
                </button>
                <button class="btn" onclick="saveToDevice()">
                    <span class="lang-zh-CN">æ‡‰ç”¨è¨­ç½®</span>
                    <span class="lang-en">Apply Settings</span>
                </button>
                <button class="btn btn-secondary" onclick="saveToEEPROM()">
                    <span class="lang-zh-CN">ä¿å­˜åˆ° EEPROM</span>
                    <span class="lang-en">Save to EEPROM</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentLanguage = 'en';
        let isEmergencyStopActive = false; // Track emergency stop status

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async function() {
            // å¾å¾Œç«¯ API è¼‰å…¥èªè¨€è¨­å®šï¼ˆåªè®€å–ï¼Œä¸æä¾›åˆ‡æ›ï¼‰
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                if (data.language) {
                    currentLanguage = data.language;
                    console.log('âœ… Settings é é¢å¾ API è¼‰å…¥èªè¨€:', currentLanguage);
                }
            } catch (error) {
                console.error('âŒ ç„¡æ³•å¾ API è¼‰å…¥èªè¨€è¨­å®š:', error);
                // é™ç´šåˆ° localStorage
                const savedLanguage = localStorage.getItem('language') || 'en';
                currentLanguage = savedLanguage;
                console.log('âš ï¸ Settings é é¢å¾ localStorage è¼‰å…¥èªè¨€:', currentLanguage);
            }

            updateLanguageDisplay();

            // è¼‰å…¥è¨­ç½®
            loadSettings();

            // å®šæœŸæ›´æ–°è¨­ç½®ï¼ˆæ¯ 5 ç§’è¼ªè©¢ï¼Œç¢ºä¿èˆ‡æ§åˆ¶å°å‘½ä»¤åŒæ­¥ï¼‰
            setInterval(updateSettingsQuietly, 5000);

            // è¼‰å…¥ç³»çµ±ç‹€æ…‹
            updateSystemStatus();
            setInterval(updateSystemStatus, 2000);

            // LED äº®åº¦æ»‘æ¡¿äº‹ä»¶
            document.getElementById('ledBrightness').addEventListener('input', function() {
                document.getElementById('ledBrightnessValue').textContent = this.value;
            });
        });

        // è·¨é é¢èªè¨€åŒæ­¥ - ç›£è½ä¸»é é¢çš„èªè¨€è®Šæ›´
        window.addEventListener('storage', function(e) {
            if (e.key === 'language' && e.newValue !== null) {
                const newLang = e.newValue;
                if (newLang !== currentLanguage) {
                    console.log('âœ… èªè¨€å·²å¾ä¸»é é¢è®Šæ›´ç‚º:', newLang);
                    currentLanguage = newLang;
                    updateLanguageDisplay();
                }
            }
        });

        // æ›´æ–°èªè¨€é¡¯ç¤º
        function updateLanguageDisplay() {
            // éš±è—æ‰€æœ‰èªè¨€å…ƒç´ 
            document.querySelectorAll('.lang-en, .lang-zh-CN').forEach(el => {
                el.style.display = 'none';
            });
            // é¡¯ç¤ºç•¶å‰èªè¨€çš„å…ƒç´ 
            document.querySelectorAll('.lang-' + currentLanguage).forEach(el => {
                el.style.display = 'inline';
            });
            console.log('èªè¨€é¡¯ç¤ºå·²æ›´æ–°ç‚º:', currentLanguage);
        }

        // è¼‰å…¥è¨­ç½®
        async function loadSettings() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();

                document.getElementById('title').value = data.title || '';
                document.getElementById('subtitle').value = data.subtitle || '';
                document.getElementById('bleDeviceName').value = data.bleDeviceName || '';
                document.getElementById('dutyStepSize').value = data.dutyStepSize || 1.0;
                document.getElementById('freqStepSize').value = data.freqStepSize || 10;
                document.getElementById('maxFrequency').value = data.maxFrequency || 100000;
                document.getElementById('maxSafeRPM').value = data.maxSafeRPM || 500000;
                document.getElementById('maxSafeRPMEnabled').checked = (data.maxSafeRPMEnabled === true);
                document.getElementById('polePairs').value = data.polePairs || 2;
                document.getElementById('rpmUpdateRate').value = data.rpmUpdateRate || 100;
                document.getElementById('ledBrightness').value = data.ledBrightness || 25;
                document.getElementById('ledBrightnessValue').textContent = data.ledBrightness || 25;
                document.getElementById('wifiSSID').value = data.wifiSSID || '';
                // Don't clear password field if server returns empty (for security)
                // Keep existing value or show placeholder
                if (data.wifiPassword) {
                    document.getElementById('wifiPassword').value = data.wifiPassword;
                } else if (data.wifiSSID) {
                    // If SSID exists but password is empty (security), show placeholder
                    document.getElementById('wifiPassword').placeholder = '(å·²ä¿å­˜ / Saved)';
                }

                // è¼‰å…¥ AP æ¨¡å¼è¨­å®š
                const apResponse = await fetch('/api/ap-mode');
                const apData = await apResponse.json();
                if (apData.success) {
                    document.getElementById('apModeEnabled').checked = apData.enabled || false;
                }

                showMessage('è¨­ç½®è¼‰å…¥æˆåŠŸ / Settings loaded successfully', 'success');
            } catch (error) {
                showMessage('è¼‰å…¥è¨­ç½®å¤±æ•— / Failed to load settings: ' + error.message, 'error');
            }
        }

        // éœé»˜æ›´æ–°è¨­ç½®ï¼ˆç”¨æ–¼å®šæœŸè¼ªè©¢ï¼Œä¸é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯ï¼Œä¸è¦†è“‹æ­£åœ¨ç·¨è¼¯çš„æ¬„ä½ï¼‰
        async function updateSettingsQuietly() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();

                // åªæ›´æ–°æ²’æœ‰ç„¦é»çš„æ¬„ä½ï¼ˆç”¨æˆ¶ä¸åœ¨ç·¨è¼¯ä¸­ï¼‰
                const updateIfNotFocused = (id, value) => {
                    const element = document.getElementById(id);
                    if (element && document.activeElement !== element) {
                        element.value = value || '';
                    }
                };

                updateIfNotFocused('title', data.title);
                updateIfNotFocused('subtitle', data.subtitle);
                updateIfNotFocused('bleDeviceName', data.bleDeviceName);
                updateIfNotFocused('dutyStepSize', data.dutyStepSize || 1.0);
                updateIfNotFocused('freqStepSize', data.freqStepSize || 10);
                updateIfNotFocused('maxFrequency', data.maxFrequency || 100000);
                updateIfNotFocused('maxSafeRPM', data.maxSafeRPM || 500000);
                updateIfNotFocused('polePairs', data.polePairs || 2);
                updateIfNotFocused('rpmUpdateRate', data.rpmUpdateRate || 100);
                // Don't update SSID if server returns empty (keeps user input)
                if (data.wifiSSID) {
                    updateIfNotFocused('wifiSSID', data.wifiSSID);
                }
                // Don't update password field if server returns empty (for security)
                if (data.wifiPassword) {
                    updateIfNotFocused('wifiPassword', data.wifiPassword);
                }

                // LED brightness ç‰¹æ®Šè™•ç†ï¼ˆåŒæ™‚æ›´æ–°æ»‘æ¡¿å’Œé¡¯ç¤ºå€¼ï¼‰
                const ledBrightnessEl = document.getElementById('ledBrightness');
                if (ledBrightnessEl && document.activeElement !== ledBrightnessEl) {
                    const brightness = data.ledBrightness || 25;
                    ledBrightnessEl.value = brightness;
                    document.getElementById('ledBrightnessValue').textContent = brightness;
                }

                // æ›´æ–° checkboxesï¼ˆcheckbox ä¸éœ€è¦æª¢æŸ¥ç„¦é»ï¼‰
                if (data.maxSafeRPMEnabled !== undefined) {
                    document.getElementById('maxSafeRPMEnabled').checked = data.maxSafeRPMEnabled;
                }

                const apResponse = await fetch('/api/ap-mode');
                const apData = await apResponse.json();
                if (apData.success) {
                    document.getElementById('apModeEnabled').checked = apData.enabled || false;
                }
            } catch (error) {
                // éœé»˜å¤±æ•—ï¼Œä¸é¡¯ç¤ºéŒ¯èª¤æ¶ˆæ¯ï¼ˆé¿å…å¹²æ“¾ç”¨æˆ¶ï¼‰
                console.error('Failed to update settings quietly:', error);
            }
        }

        // æ‡‰ç”¨è¨­ç½®åˆ°è£ç½®
        async function saveToDevice() {
            try {
                const settings = {
                    title: document.getElementById('title').value,
                    subtitle: document.getElementById('subtitle').value,
                    bleDeviceName: document.getElementById('bleDeviceName').value,
                    dutyStepSize: parseFloat(document.getElementById('dutyStepSize').value),
                    freqStepSize: parseInt(document.getElementById('freqStepSize').value),
                    language: currentLanguage,
                    maxFrequency: parseInt(document.getElementById('maxFrequency').value),
                    maxSafeRPM: parseInt(document.getElementById('maxSafeRPM').value),
                    maxSafeRPMEnabled: document.getElementById('maxSafeRPMEnabled').checked,
                    polePairs: parseInt(document.getElementById('polePairs').value),
                    rpmUpdateRate: parseInt(document.getElementById('rpmUpdateRate').value),
                    ledBrightness: parseInt(document.getElementById('ledBrightness').value),
                    wifiSSID: document.getElementById('wifiSSID').value
                };

                const password = document.getElementById('wifiPassword').value;
                // åªåœ¨ç”¨æˆ¶å¯¦éš›ä¿®æ”¹å¯†ç¢¼æ™‚æ‰ç™¼é€ï¼ˆä¸ç™¼é€å ä½ç¬¦ "********"ï¼‰
                if (password && password.length >= 8 && password !== '********') {
                    settings.wifiPassword = password;
                }

                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                if (data.success) {
                    // ä¿å­˜ AP æ¨¡å¼è¨­å®š
                    const apEnabled = document.getElementById('apModeEnabled').checked;
                    const apResponse = await fetch('/api/ap-mode', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: 'enabled=' + apEnabled
                    });
                    const apData = await apResponse.json();

                    if (apData.success) {
                        showMessage('è¨­ç½®å·²æ‡‰ç”¨ / Settings applied successfully', 'success');
                    } else {
                        showMessage('è¨­ç½®å·²æ‡‰ç”¨ä½† AP æ¨¡å¼è¨­å®šå¤±æ•— / Settings applied but AP mode failed', 'warning');
                    }

                    // é€šçŸ¥å…¶ä»–é é¢æ›´æ–°
                    localStorage.setItem('settingsUpdated', Date.now().toString());
                } else {
                    showMessage('æ‡‰ç”¨è¨­ç½®å¤±æ•— / Failed to apply settings', 'error');
                }
            } catch (error) {
                showMessage('æ‡‰ç”¨è¨­ç½®å¤±æ•— / Failed to apply settings: ' + error.message, 'error');
            }
        }

        // ä¿å­˜åˆ° EEPROM
        async function saveToEEPROM() {
            try {
                // å…ˆæ‡‰ç”¨è¨­ç½®
                await saveToDevice();

                // ç„¶å¾Œä¿å­˜åˆ° EEPROM
                const response = await fetch('/api/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('è¨­ç½®å·²ä¿å­˜åˆ° EEPROM / Settings saved to EEPROM successfully', 'success');
                } else {
                    showMessage('ä¿å­˜åˆ° EEPROM å¤±æ•— / Failed to save to EEPROM', 'error');
                }
            } catch (error) {
                showMessage('ä¿å­˜åˆ° EEPROM å¤±æ•— / Failed to save to EEPROM: ' + error.message, 'error');
            }
        }

        // æ›´æ–°ç³»çµ±ç‹€æ…‹
        async function updateSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                document.getElementById('firmwareVersion').textContent = data.firmwareVersion || '-';
                document.getElementById('wifiIP').textContent = data.wifiIP || '-';
                document.getElementById('uptime').textContent = data.uptime || '-';
                document.getElementById('freeHeap').textContent = (data.freeHeap ? (data.freeHeap / 1024).toFixed(1) + ' KB' : '-');

                // Handle emergency stop status
                const errorBanner = document.getElementById('errorBanner');
                const errorBannerText = document.getElementById('errorBannerText');
                if (data.emergencyStop !== undefined) {
                    const wasEmergencyStopped = isEmergencyStopActive;
                    isEmergencyStopActive = data.emergencyStop;  // Update global state

                    if (data.emergencyStop) {
                        // Update error message with RPM values (use trigger RPM, not current RPM)
                        const triggerRPM = data.emergencyStopTriggerRPM ? data.emergencyStopTriggerRPM.toFixed(1) : '---';
                        const maxRPM = data.maxSafeRPM || '---';
                        const message = currentLanguage === 'zh-CN'
                            ? `âš ï¸ å®‰å…¨è­¦å ±ï¼šç·Šæ€¥åœæ­¢å·²æ¿€æ´»ï¼è§¸ç™¼è½‰é€Ÿï¼š${triggerRPM} RPM / æœ€å¤§å®‰å…¨è½‰é€Ÿï¼š${maxRPM} RPM`
                            : `âš ï¸ SAFETY ALERT: Emergency stop activated! Trigger RPM: ${triggerRPM} / Max Safe RPM: ${maxRPM}`;
                        errorBannerText.textContent = message;
                        errorBanner.classList.add('show');

                        // Show popup notification when emergency stop FIRST activates (transition from false to true)
                        if (!wasEmergencyStopped) {
                            const popupMessage = currentLanguage === 'zh-CN'
                                ? `â›” ç·Šæ€¥åœæ­¢æ¿€æ´»ï¼\n\nè§¸ç™¼è½‰é€Ÿï¼š${triggerRPM} RPM\næœ€å¤§å®‰å…¨è½‰é€Ÿï¼š${maxRPM} RPM\n\né›»æ©Ÿå·²åœæ­¢ï¼Œè«‹æª¢æŸ¥ä¸¦æ¸…é™¤éŒ¯èª¤ã€‚`
                                : `â›” EMERGENCY STOP ACTIVATED!\n\nTrigger RPM: ${triggerRPM}\nMax Safe RPM: ${maxRPM}\n\nMotor stopped. Please check and clear error.`;
                            alert(popupMessage);
                        }
                    } else {
                        errorBanner.classList.remove('show');
                    }
                }
            } catch (error) {
                console.error('Failed to update system status:', error);
            }
        }

        // Clear emergency stop error
        async function clearError() {
            const confirmMessage = currentLanguage === 'zh-CN'
                ? 'æ¸…é™¤ç·Šæ€¥åœæ­¢ä¸¦æ¢å¾©æ­£å¸¸æ“ä½œï¼Ÿ'
                : 'Clear emergency stop and resume normal operation?';

            if (confirm(confirmMessage)) {
                try {
                    const response = await fetch('/api/motor/clear-error', {
                        method: 'POST'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            const successMessage = currentLanguage === 'zh-CN'
                                ? 'éŒ¯èª¤å·²æ¸…é™¤ - ç³»çµ±å·²æ¢å¾©'
                                : 'Emergency stop cleared - System resumed';
                            showMessage(successMessage, 'success');
                            // Force immediate status update
                            updateSystemStatus();
                        } else {
                            showMessage('Failed to clear error', 'error');
                        }
                    } else {
                        showMessage('Connection error', 'error');
                    }
                } catch (error) {
                    console.error('Error clearing emergency stop:', error);
                    showMessage('Connection error', 'error');
                }
            }
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type) {
            const msgElement = document.getElementById('statusMessage');
            msgElement.textContent = message;
            msgElement.className = 'status-message ' + type;
            msgElement.style.display = 'block';

            setTimeout(() => {
                msgElement.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
